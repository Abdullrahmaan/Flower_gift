<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíå Digital Flower Garden</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease-in-out;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #fcfcfc;
        }
        .hidden { display: none !important; }
        
        /* Interactive Elements */
        .flower-button:hover { transform: scale(1.05); }
        .flower-selected { border-color: #7B68EE !important; border-width: 4px !important; }
        
        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        /* Garden Canvas */
        #garden-canvas {
            border: 8px solid #383e18;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            image-rendering: pixelated;
            max-width: 100%;
        }
    </style>
</head>
<body>

    <button id="nav-button" class="fixed top-4 right-4 hidden bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-700 z-50">
        View Garden ü™¥
    </button>

    <div id="builder-view" class="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-xl mt-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-[#7B68EE] mb-2">üíå Build a Flower Gift</h1>
            <p class="text-gray-600">Create a digital seed that grows into a message.</p>
        </header>

        <div class="mb-6">
            <label class="block text-lg font-bold text-gray-700 mb-2">1. Your Message</label>
            <textarea id="input-message" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-[#7B68EE]" rows="3" placeholder="e.g. Happy Birthday!"></textarea>
        </div>

        <div class="mb-6">
            <label class="block text-lg font-bold text-gray-700 mb-2">2. Choose Flower</label>
            <div class="grid grid-cols-4 gap-4" id="flower-options">
                <button onclick="selectFlower('Rose', this)" class="flower-button border-2 border-transparent bg-pink-50 p-2 rounded-xl">
                    <img src="./Rose.png" class="mx-auto rounded">
                    <span class="text-xs font-bold text-pink-600">Rose</span>
                </button>
                <button onclick="selectFlower('Tulip', this)" class="flower-button border-2 border-transparent bg-yellow-50 p-2 rounded-xl">
                    <img src="./Tulip.jpeg" class="mx-auto rounded">
                    <span class="text-xs font-bold text-yellow-600">Tulip</span>
                </button>
                <button onclick="selectFlower('Daisy', this)" class="flower-button border-2 border-transparent bg-gray-50 p-2 rounded-xl">
                    <img src="./Daisy.jpg" class="mx-auto rounded">
                    <span class="text-xs font-bold text-gray-600">Daisy</span>
                </button>
                <button onclick="selectFlower('Orchid', this)" class="flower-button border-2 border-transparent bg-purple-50 p-2 rounded-xl">
                    <img src="./Orchid.png" class="mx-auto rounded">
                    <span class="text-xs font-bold text-purple-600">Orchid</span>
                </button>
            </div>
            <input type="hidden" id="selected-flower" value="Rose">
        </div>

        <div class="mb-6">
            <label class="block text-lg font-bold text-gray-700 mb-2">3. Theme Color</label>
            <select id="input-theme" class="w-full p-3 border rounded-lg bg-white">
                <option value="Forest">üå≥ Forest Green</option>
                <option value="Lavender">üíú Lavender Dream</option>
                <option value="Sunshine">‚òÄÔ∏è Sunshine Yellow</option>
                <option value="Ocean">üåä Ocean Blue</option>
            </select>
        </div>

        <div class="mb-8">
            <label class="block text-lg font-bold text-gray-700 mb-2">4. Clicks to Bloom</label>
            <input type="number" id="input-clicks" class="w-full p-3 border rounded-lg" value="5" min="1" max="20">
        </div>

        <button onclick="generateLink()" class="w-full py-4 text-white bg-[#7B68EE] hover:bg-[#6A5ACD] font-bold text-xl rounded-lg shadow-lg transition transform hover:scale-105">
            üéÅ Generate Gift Link
        </button>

        <div id="result-area" class="hidden mt-6 p-4 bg-gray-100 rounded-xl border-dashed border-2 border-gray-300 text-center">
            <p class="text-gray-600 mb-2">Share this link:</p>
            <p id="share-link" class="font-mono text-sm bg-white p-2 rounded select-all break-all mb-3"></p>
            <button onclick="copyLink()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Copy Link</button>
        </div>
    </div>


    <div id="gift-view" class="hidden w-full max-w-lg mt-10 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-[#7B68EE]">
            
            <div id="seed-stage">
                <h1 id="water-title" class="text-2xl font-bold text-gray-800 mb-4">Someone sent you a flower!</h1>
                <p class="text-gray-500 mb-6">Tap the watering can to make it bloom.</p>
                
                <div class="relative inline-block cursor-pointer group" onclick="waterPlant()">
                    <img src="./watering_can.png" class="w-32 mx-auto animate-float transition transform group-active:rotate-12">
                    <div class="mt-4">
                    </div>
                </div>
                <p id="click-counter" class="mt-4 font-bold text-[#7B68EE]">5 drops needed</p>
            </div>

            <div id="bloom-stage" class="hidden">
                <h1 class="text-3xl font-extrabold text-green-600 mb-4 animate-bounce">It Bloomed!</h1>
                <img id="final-flower-img" src="" class="w-48 mx-auto mb-6 rounded-xl shadow-lg">
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <p id="final-message" class="text-xl font-handwriting italic text-gray-800"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="garden-view" class="hidden w-full text-center p-4">
        <h1 class="text-4xl font-bold text-white mb-4 drop-shadow-md">Your Garden</h1>
        <div id="garden-container" class="max-w-4xl mx-auto">
            <canvas id="garden-canvas"></canvas>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // 1. FIREBASE CONFIGURATION
      const firebaseConfig = {
  apiKey: "AIzaSyCC1QeQsUiSxLoKTJfAomwuW2CPJsYe5mU",
  authDomain: "flower-gift-b16b9.firebaseapp.com",
  projectId: "flower-gift-b16b9",
  storageBucket: "flower-gift-b16b9.firebasestorage.app",
  messagingSenderId: "508370263382",
  appId: "1:508370263382:web:27c88f5cf0a9b3435d0af7"
};
        // ------------------------------------------------------------------

        // Initialize Firebase
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            auth.signInAnonymously().catch(console.error);
        } catch (e) {
            console.error("Firebase Config Error: Did you paste your keys?", e);
            alert("Error: Firebase keys missing in code.");
        }
        const THEMES = {
            'Forest': '#383e18',
            'Lavender': '#e6e6fa',
            'Sunshine': '#fdfd96',
            'Ocean': '#e0f7fa'
        };

        let giftData = null;
        let clicksLeft = 0;

        // ------------------------------------------------------------------
        // 2. INITIALIZATION & ROUTING
        // ------------------------------------------------------------------
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            
            // Check if we are opening a gift link
            if (params.has('flower') && params.has('message')) {
                // We are in Viewer Mode
                giftData = {
                    flower: params.get('flower'),
                    message: decodeURIComponent(params.get('message')),
                    theme: params.get('theme'),
                    clicks: parseInt(params.get('clicks')) || 5
                };
                startGiftView();
            } else {
                // We are in Builder Mode
                document.getElementById('builder-view').classList.remove('hidden');
                // Highlight first flower
                document.querySelector('.flower-button').classList.add('flower-selected');
            }
        });

        // ------------------------------------------------------------------
        // 3. BUILDER LOGIC
        // ------------------------------------------------------------------
        function selectFlower(flowerName, btnElement) {
            document.getElementById('selected-flower').value = flowerName;
            
            // Visual Update
            document.querySelectorAll('.flower-button').forEach(b => b.classList.remove('flower-selected'));
            btnElement.classList.add('flower-selected');
        }

        function generateLink() {
            const flower = document.getElementById('selected-flower').value;
            const message = encodeURIComponent(document.getElementById('input-message').value || "A gift for you!");
            const theme = document.getElementById('input-theme').value;
            const clicks = document.getElementById('input-clicks').value;

            // Create URL (Current Page + Query Params)
            const baseUrl = window.location.href.split('?')[0];
            const fullLink = `${baseUrl}?flower=${flower}&message=${message}&theme=${theme}&clicks=${clicks}`;

            document.getElementById('share-link').innerText = fullLink;
            document.getElementById('result-area').classList.remove('hidden');
        }

        function copyLink() {
            const linkText = document.getElementById('share-link').innerText;
            navigator.clipboard.writeText(linkText).then(() => {
                alert("Link copied!");
            });
        }

        // ------------------------------------------------------------------
        // 4. GIFT VIEWER LOGIC
        // ------------------------------------------------------------------
        function startGiftView() {
            // Hide builder, show gift
            document.getElementById('builder-view').classList.add('hidden');
            document.getElementById('gift-view').classList.remove('hidden');

            // Apply Theme
            document.body.style.backgroundColor = THEMES[giftData.theme] || '#fcfcfc';

            // Setup Game
            clicksLeft = giftData.clicks;
            document.getElementById('click-counter').innerText = `${clicksLeft} drops needed`;
            
            // Setup Nav
            const navBtn = document.getElementById('nav-button');
            navBtn.classList.remove('hidden');
            navBtn.innerText = "View Garden ü™¥";
            navBtn.onclick = () => showGarden();
        }

        function waterPlant() {
            if (clicksLeft > 0) {
                clicksLeft--;
                document.getElementById('click-counter').innerText = 
                    clicksLeft > 0 ? `${clicksLeft} drops needed...` : "Blooming...";
                
                if (clicksLeft === 0) {
                    revealGift();
                }
            }
        }

        function revealGift() {
            const imgUrl = FLOWER_IMAGES[giftData.flower] || FLOWER_IMAGES['Rose'];
            
            document.getElementById('seed-stage').classList.add('hidden');
            document.getElementById('bloom-stage').classList.remove('hidden');
            
            document.getElementById('final-flower-img').src = imgUrl;
            document.getElementById('final-message').innerText = giftData.message;

            saveToGarden();
        }

        function saveToGarden() {
            // Save to Firestore (Anonymous User)
            if (auth.currentUser) {
                const userId = auth.currentUser.uid;
                db.collection('users').doc(userId).collection('garden').add({
                    flower: giftData.flower,
                    message: giftData.message,
                    date: new Date(),
                    x: Math.random(), // Random position for garden
                    y: Math.random()
                });
            }
        }

        // ------------------------------------------------------------------
        // 5. GARDEN LOGIC
        // ------------------------------------------------------------------
        function showGarden() {
            document.getElementById('gift-view').classList.add('hidden');
            document.getElementById('garden-view').classList.remove('hidden');
            document.body.style.backgroundColor = '#383e18'; // Dark garden background

            const canvas = document.getElementById('garden-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set size
            canvas.width = 800;
            canvas.height = 400;

            // Draw Background
            ctx.fillStyle = "#4B5320";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Fetch and Draw Flowers
            if (auth.currentUser) {
                const userId = auth.currentUser.uid;
                db.collection('users').doc(userId).collection('garden').get().then(snap => {
                    snap.forEach(doc => {
                        const data = doc.data();
                        const img = new Image();
                        img.src = FLOWER_IMAGES[data.flower];
                        img.onload = () => {
                            const x = data.x * (canvas.width - 50);
                            const y = data.y * (canvas.height - 50);
                            ctx.drawImage(img, x, y, 50, 50);
                        };
                    });
                });
            }
            
            // Nav Toggle
            const navBtn = document.getElementById('nav-button');
            navBtn.innerText = "Back to Gift üéÅ";
            navBtn.onclick = () => {
                document.getElementById('garden-view').classList.add('hidden');
                document.getElementById('gift-view').classList.remove('hidden');
                document.body.style.backgroundColor = THEMES[giftData.theme];
            };
        }

    </script>
</body>
</html>



